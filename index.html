<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>EML Attachment Extractor</title>
</head>
<body>
    <h1>EML Attachment Extractor</h1>
    <input type="file" id="emlFile" accept=".eml">
    <div id="output"></div>

    <script src="wasm_exec.js"></script>
    <script>
        const go = new Go();
        WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject)
            .then(result => {
                go.run(result.instance);
                setupFileHandler();
            });

        function setupFileHandler() {
            document.getElementById('emlFile').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const arrayBuffer = await file.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);
                
                const attachments = extractAttachments(uint8Array);
                
                const output = document.getElementById('output');
                output.innerHTML = '<h2>Attachments:</h2>';
                
                const inlineImages = {};
                attachments.forEach(att => {
                    if (att.type.startsWith('image/')) {
                        const base64 = btoa(String.fromCharCode(...att.data));
                        inlineImages[att.name] = `data:${att.type};base64,${base64}`;
                    }
                });
                
                attachments.forEach(att => {
                    if (att.isBody) {
                        let html = new TextDecoder().decode(att.data);
                        Object.entries(inlineImages).forEach(([name, dataUrl]) => {
                            html = html.replaceAll(`cid:${name}`, dataUrl);
                        });
                        output.innerHTML += `
                            <details open>
                                <summary>ðŸ“§ HTML Body (${att.data.length} bytes)</summary>
                                <iframe srcdoc="${html.replace(/"/g, '&quot;')}" style="width:100%;height:400px;border:1px solid #ccc"></iframe>
                            </details>
                        `;
                    } else {
                        const blob = new Blob([att.data], { type: att.type });
                        const url = URL.createObjectURL(blob);
                        output.innerHTML += `
                            <div>
                                ðŸ“Ž <a href="${url}" download="${att.name}">${att.name}</a>
                                (${att.type}, ${att.data.length} bytes)
                            </div>
                        `;
                    }
                });
            });
        }
    </script>
</body>
</html>
